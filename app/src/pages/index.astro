---
import Welcome from '../components/Welcome.astro';
import Layout from '../layouts/Layout.astro';

type BlogItem = {
  title: string;
  body: string;
};

const API_URL = 'https://can2blog.microcms.io/api/v1/blogs';
const API_KEY = import.meta.env.MICROCMS_API_KEY;

let data: { contents: BlogItem[] } = { contents: [] };
let error = '';

try {
  const res = await fetch(API_URL, {
    headers: { 'X-API-KEY': API_KEY }
  });
  if (!res.ok) {
    error = `APIエラー: ${res.status} ${res.statusText}`;
  } else {
    data = await res.json();
  }
} catch (e) {
  const err = e as Error;
  error = `通信エラー: ${err.message}`;
}

console.log('API_URL:', API_URL);
console.log('API_KEY:', API_KEY);
---

<Layout>
	<Welcome />
</Layout>

<h1>記事一覧</h1>
{error
  ? <p style="color:red">{error}</p>
  : (
    <ul>
      {data.contents.map((item) => (
        <li>
          <strong>{item.title}</strong><br />
          <span>{item.body}</span>
        </li>
      ))}
    </ul>
  )
}
