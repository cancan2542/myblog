---
import Layout from '../layouts/Layout.astro';
import PlayerStatus from '../components/PlayerStatus.astro';
import CategoryTabs from '../components/CategoryTabs.astro';
import BlogCard from '../components/BlogCard.astro';
import { getArticles } from '../lib/microcms';

const title = "ホーム";

// microCMSから記事を取得
const articles = await getArticles();

// 日付フォーマット
const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return date.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '.');
};

// 記事データを変換
const posts = articles.map((article) => ({
  id: article.id,
  title: article.title,
  description: article.description || '',
  image: article.image?.url || 'https://images.unsplash.com/photo-1484480974693-6ca0a78fb36b?w=400&h=225&fit=crop',
  date: formatDate(article.publishedAt || article.createdAt),
  category: article.category?.name || 'Uncategorized',
  tag: article.tag || article.category?.name?.toUpperCase() || 'GENERAL',
}));

// カテゴリ一覧を取得
const categories = ['All', ...new Set(posts.map(p => p.category))];
---

<Layout title={title}>
  <!-- Press Start Section -->
  <div style="text-align: center; margin: 3rem 0; padding: 2rem; background: #fff; border: 3px solid #333; box-shadow: 8px 8px 0 rgba(0,0,0,0.2);">
    <div style="font-family: 'Press Start 2P', monospace; font-size: 2rem; letter-spacing: 4px; margin-bottom: 1rem; color: #000;">
      PRESS START
    </div>
    <p style="font-size: 1rem; color: #666; font-family: 'Courier New', monospace;">
      古いゲーム機を現代によみがえらせるブログ
    </p>
  </div>

  <!-- Category Tabs -->
  <CategoryTabs categories={categories} />

  <!-- Blog Posts Grid -->
  <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem; margin: 2rem 0;">
    {posts.length > 0 ? (
      posts.map((post) => (
        <div data-category={post.category}>
          <a href={`/posts/${post.id}`} style="text-decoration: none;">
            <BlogCard
              tag={post.tag}
              date={post.date}
              title={post.title}
              description={post.description}
              image={post.image}
              category={post.category}
            />
          </a>
        </div>
      ))
    ) : (
      <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; background: #fff; border: 2px solid #333;">
        <p style="font-family: 'Courier New', monospace; color: #666;">
          まだ記事がありません。microCMSで記事を作成してください。
        </p>
      </div>
    )}
  </div>
</Layout>
