---
import Layout from '../../layouts/Layout.astro';
import ArticleHeader from '../../components/ArticleHeader.astro';
import ArticleContent from '../../components/ArticleContent.astro';
import { getArticles, getArticle } from '../../lib/microcms';
import { formatDate } from '../../utils/dateFormatter';

// 静的生成用のパスを生成
export async function getStaticPaths() {
  const articles = await getArticles();
  return articles.map((article) => ({
    params: { id: article.id },
  }));
}

const { id } = Astro.params;
const article = await getArticle(id);

if (!article) {
  return Astro.redirect('/404');
}
---

<Layout title={article.title}>
  <nav class="breadcrumb" aria-label="パンくずリスト">
    <a href="/">Home</a>
    <span class="separator">/</span>
    <a href="/">Posts</a>
    <span class="separator">/</span>
    <span class="current">{article.title}</span>
  </nav>

  <ArticleHeader
    title={article.title}
    image={article.image?.url || ''}
    date={formatDate(article.createdAt)}
    category={article.category?.name || ''}
    tag={article.tag || article.category?.name?.toUpperCase() || 'GENERAL'}
  />

  {article.updatedAt && article.updatedAt !== article.createdAt && (
    <div class="updated-date">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      <span>最終更新日: {formatDate(article.updatedAt)}</span>
    </div>
  )}

  <ArticleContent content={article.content} />
</Layout>

<style>
  .breadcrumb {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 1rem 0 1.5rem;
    padding: 0.75rem 1rem;
    background: #fff;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    font-size: 0.85rem;
  }

  .breadcrumb a {
    color: var(--color-accent);
    text-decoration: none;
    transition: opacity 0.2s;
  }

  .breadcrumb a:hover {
    opacity: 0.7;
  }

  .breadcrumb .separator {
    color: var(--color-text-muted);
  }

  .breadcrumb .current {
    color: var(--color-text-muted);
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .updated-date {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    padding: 0.75rem 1rem;
    background: var(--color-background-dark);
    border-radius: var(--border-radius);
    color: var(--color-text-muted);
    font-size: 0.85rem;
  }

  .updated-date svg {
    flex-shrink: 0;
  }

  /* Mobile: 〜767px */
  @media (max-width: 767px) {
    .breadcrumb {
      margin: 0.5rem 0 1rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.8rem;
      gap: 0.25rem;
    }

    .breadcrumb .current {
      max-width: 150px;
    }

    .updated-date {
      margin-bottom: 1rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.8rem;
    }
  }
</style>
